# -----------------------------------------------------------------------
# URL Rewriting
# -----------------------------------------------------------------------
# Use SymLinksIfOwnerMatch instead of FollowSymLinks: it satisfies
# mod_rewrite's requirement while avoiding the 403 Forbidden that many
# cPanel/shared-hosting servers return when +FollowSymLinks appears in
# .htaccess (triggered by the server's symlink-attack protection).
Options +SymLinksIfOwnerMatch -Indexes
DirectoryIndex index.php
RewriteEngine On

# NOTE: open_basedir is configured in .user.ini (PHP-FPM per-directory ini).
# DO NOT set php_admin_value / php_value here: those directives require
# AllowOverride Options in httpd.conf. When that permission is absent
# (common on cPanel shared hosting) Apache returns 403 Forbidden for the
# ENTIRE directory, blocking every page including /configuraciones.

# Seguridad adicional - Headers HTTP
<IfModule mod_headers.c>
    # Prevenir Clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Protección XSS en navegadores antiguos
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevenir MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Política de Referrer (no enviar información sensible)
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Eliminar información del servidor
    Header unset X-Powered-By
    Header always unset X-Powered-By
</IfModule>

# Route all non-file, non-directory requests through the PHP application router.
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]

# Proteger archivos de configuración
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        # Apache 2.4+
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        # Apache 2.2
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Proteger archivos sensibles
<FilesMatch "\.(sql|env|log|ini|md)$">
    <IfModule mod_authz_core.c>
        # Apache 2.4+
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        # Apache 2.2
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>
